# Sistema de Ventas con Notificaciones

Taller de Arquitectura de Software - Sistema de ventas con notificaciones a proveedores (Kafka) y clientes (JMS/MDB)

## Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          FLUJO DE NOTIFICACIONES                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

     Cliente HTTP Request
            ‚îÇ
            ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Inventory   ‚îÇ ‚Üê Consultar productos y proveedores
    ‚îÇ   Service     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Payments    ‚îÇ ‚Üê (Opcional) Procesar pago
    ‚îÇ   Service     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ              BILLING SERVICE (Orquestador)                    ‚îÇ
    ‚îÇ  ‚Ä¢ Crea factura en BD                                         ‚îÇ
    ‚îÇ  ‚Ä¢ Agrupa items por proveedor                                 ‚îÇ
    ‚îÇ  ‚Ä¢ Dispara notificaciones                                     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                                     ‚îÇ
                 ‚îÇ                                     ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  KAFKA PRODUCER   ‚îÇ              ‚îÇ   JMS PRODUCER     ‚îÇ
        ‚îÇ  (Spring Kafka)   ‚îÇ              ‚îÇ  (Spring JMS)      ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                                     ‚îÇ
                 ‚îÇ JSON                                ‚îÇ JSON
                 ‚îÇ                                     ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   KAFKA BROKER    ‚îÇ              ‚îÇ  ARTEMIS JMS       ‚îÇ
        ‚îÇ  Topics din√°micos ‚îÇ              ‚îÇ  (WildFly)         ‚îÇ
        ‚îÇ  supplier-1       ‚îÇ              ‚îÇ  Queue:            ‚îÇ
        ‚îÇ  supplier-2       ‚îÇ              ‚îÇ  customer-         ‚îÇ
        ‚îÇ  supplier-N       ‚îÇ              ‚îÇ  notifications     ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                                     ‚îÇ
                 ‚îÇ Pattern: supplier-.*                ‚îÇ
                 ‚îÇ                                     ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ SUPPLIER-LISTENER ‚îÇ              ‚îÇ NOTIFICATION-MDB   ‚îÇ
        ‚îÇ (Kafka Consumer)  ‚îÇ              ‚îÇ (Message Driven    ‚îÇ
        ‚îÇ Spring Boot       ‚îÇ              ‚îÇ  Bean - Jakarta EE)‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                                     ‚îÇ
                 ‚Üì                                     ‚Üì
        üìã Log Notificaci√≥n                   üìß Simula Email
        a Proveedores                         al Cliente


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        CAPA DE DATOS (Aggregator)                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  MySQL Inventory ‚îÇ MySQL Billing   ‚îÇ MySQL Payments ‚îÇ                  ‚îÇ
‚îÇ  ‚Ä¢ Products      ‚îÇ ‚Ä¢ Invoices      ‚îÇ ‚Ä¢ Payments     ‚îÇ  Aggregator DAL  ‚îÇ
‚îÇ  ‚Ä¢ Suppliers     ‚îÇ ‚Ä¢ InvoiceItems  ‚îÇ                ‚îÇ  (Spring Boot)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo de Mensajer√≠a

1. **Billing Service** recibe petici√≥n de crear factura con items
2. **Agrupaci√≥n**: Agrupa items por `supplierId`
3. **Notificaci√≥n a Proveedores (Kafka)**:
   - Por cada proveedor ‚Üí Publica mensaje en topic `supplier-{id}`
   - `supplier-listener` consume mensajes de todos los topics `supplier-.*`
   - Registra la notificaci√≥n en logs
4. **Notificaci√≥n a Cliente (JMS)**:
   - Publica UN mensaje a la cola `customer-notifications`
   - MDB en WildFly consume el mensaje
   - Simula env√≠o de email al cliente

## Tecnolog√≠as

- **Spring Boot 3.4.0**: Microservicios
- **MySQL 8.0**: 3 bases de datos (inventory, billing, payments)
- **Kafka 7.5.0**: Mensajer√≠a punto a punto para proveedores
- **WildFly 31 con Artemis integrado**: Servidor Jakarta EE con MDB y JMS Queue para notificaciones a clientes
- **Docker Compose**: Orquestaci√≥n de contenedores
- **Maven 3.9+**: Gesti√≥n de dependencias y compilaci√≥n

## Estructura de Servicios

| Servicio | Puerto | Descripci√≥n |
|----------|--------|-------------|
| aggregator-service | 8090 | DAL: Acceso a datos de las 3 BDs |
| payments-service | 8082 | Gesti√≥n de pagos |
| inventory-service | 8081 | Gesti√≥n de inventario |
| billing-service | 8083 | Facturaci√≥n y env√≠o de notificaciones |
| supplier-listener | 8084 | Consumer Kafka (notif. proveedores) |
| notification-mdb | 8085 | MDB en WildFly (notif. clientes) |
| mysql_inventory | 3307 | BD Inventario y Proveedores |
| mysql_billing | 3308 | BD Facturas |
| mysql_payments | 3309 | BD Pagos |
| kafka | 9092/29092 | Broker Kafka (interno: 9092, externo: 29092) |
| zookeeper | 2181 | Coordinador de Kafka |
| wildfly artemis | 61616 | JMS Artemis integrado en WildFly |
| wildfly console | 9990 | Consola administraci√≥n WildFly |

## Pre-requisitos

- Docker y Docker Compose
- Maven 3.9+
- Java 17+
- **Postman** (para realizar las peticiones HTTP a los servicios)

## Construcci√≥n y Despliegue

### Opci√≥n 1: Despliegue R√°pido (Recomendado)

Si los servicios ya est√°n compilados previamente, simplemente ejecuta:

```powershell
docker-compose up --build -d
```

Docker Compose construir√° autom√°ticamente todos los servicios desde sus Dockerfiles. Este proceso puede tardar 3-5 minutos la primera vez.

### Opci√≥n 2: Compilaci√≥n Manual

Si prefieres compilar manualmente antes de desplegar:

#### 1. Compilar servicios Spring Boot

```powershell
# Aggregator Service
cd aggregator-service
mvn clean package -DskipTests
cd ..

# Payments Service
cd payments-service
mvn clean package -DskipTests
cd ..

# Inventory Service
cd inventory-service
mvn clean package -DskipTests
cd ..

# Billing Service
cd billing-service
mvn clean package -DskipTests
cd ..

# Supplier Listener
cd supplier-listener
mvn clean package -DskipTests
cd ..
```

#### 2. Compilar el MDB (WildFly)

```powershell
cd notification-mdb
mvn clean package -DskipTests
cd ..
```

#### 3. Levantar con Docker Compose

```powershell
docker-compose up -d
```

**Nota**: El flag `-d` (detached) ejecuta los contenedores en segundo plano.

### Verificar Estado de los Contenedores

```powershell
docker-compose ps
```

Todos los servicios deben mostrar estado "running" o "healthy".

## Prueba del Sistema

> **üí° Nota**: Todas las peticiones HTTP se realizan usando **Postman**. A continuaci√≥n se detallan los endpoints con su configuraci√≥n completa.

### Verificar servicios activos

#### Health Checks (GET en Postman):
- **Aggregator**: `http://localhost:8090/actuator/health`
- **Inventory**: `http://localhost:8081/actuator/health`
- **Payments**: `http://localhost:8082/actuator/health`

#### Verificar estado de contenedores (PowerShell):
```powershell
docker-compose ps
```

#### Consola WildFly (Navegador):
- URL: `http://localhost:9990`
- Usuario: `admin`
- Password: `admin123`

### Ver logs de servicios

```powershell
# Logs de Kafka consumer (notificaciones proveedores)
docker logs supplier-listener -f

# Logs de MDB (notificaciones clientes)
docker logs notification-mdb -f

# Logs de billing service
docker logs billing-service -f

# Logs de Kafka
docker logs kafka -f
```

### üìÆ Colecci√≥n de Postman Lista para Importar

**¬°Importa la colecci√≥n completa en un solo click!**

üìÅ **Archivos incluidos**:
- `postman_collection.json` - Colecci√≥n completa con todas las peticiones
- `POSTMAN_GUIDE.md` - **Gu√≠a detallada paso a paso para usar Postman** üìò

**C√≥mo importar:**
1. Abre Postman
2. Click en **"Import"** (esquina superior izquierda)
3. Selecciona el archivo `postman_collection.json`
4. La colecci√≥n **"Taller 5 - Sistema de Ventas con Notificaciones"** aparecer√° en tu workspace

> **üí° ¬øPrimera vez usando la colecci√≥n?** Lee `POSTMAN_GUIDE.md` para instrucciones detalladas y tips

**La colecci√≥n incluye:**
1. ‚úÖ **Health Checks** - Verificar que todos los servicios est√©n activos
2. üì¶ **Consultar Productos** - Ver productos con proveedores
3. üí≥ **Crear Pago (Opcional)** - Simular un pago (guarda autom√°ticamente el `paymentId`)
4. üìÑ **Crear Factura - Opci√≥n A** - Sin paymentId (m√°s simple)
5. üìÑ **Crear Factura - Opci√≥n B** - Con paymentId (usa variable autom√°tica)

**Tips para Postman:**
- La petici√≥n de crear pago **guarda autom√°ticamente** el `paymentId` en una variable de entorno
- La opci√≥n B de crear factura usa `{{paymentId}}` para referenciar el pago previo
- Todas las peticiones tienen descripciones detalladas
- Activa la opci√≥n **"Save Responses"** para revisar el historial

### Flujo de Prueba Completo

#### 1. Consultar productos disponibles üì¶

**Configuraci√≥n en Postman:**

| Campo | Valor |
|-------|-------|
| **M√©todo** | `GET` |
| **URL** | `http://localhost:8081/api/products` |
| **Headers** | No requeridos |
| **Body** | No requerido |

**Pasos:**
1. Selecciona m√©todo `GET`
2. Copia y pega la URL
3. Click en **"Send"**

**Respuesta esperada** (Status 200):
```json
[
  {
    "id": 1,
    "name": "Laptop",
    "price": 2500.00,
    "stock": 10,
    "supplier": {
      "id": 1,
      "name": "TechSupplier Inc",
      "email": "orders@techsupplier.com"
    }
  },
  {
    "id": 2,
    "name": "Mouse",
    "price": 40.00,
    "stock": 100,
    "supplier": {
      "id": 2,
      "name": "Electronics Co",
      "email": "sales@electronicsco.com"
    }
  },
  {
    "id": 3,
    "name": "Teclado",
    "price": 80.00,
    "stock": 50,
    "supplier": {
      "id": 2,
      "name": "Electronics Co",
      "email": "sales@electronicsco.com"
    }
  }
]
```

#### 2. (Opcional) Crear un pago üí≥

Este paso es opcional si quieres simular el flujo completo con payments-service.

**Configuraci√≥n en Postman:**

| Campo | Valor |
|-------|-------|
| **M√©todo** | `POST` |
| **URL** | `http://localhost:8082/api/payments/charge` |
| **Headers** | `Content-Type: application/json` |
| **Body** | raw ‚Üí JSON |

**Pasos:**
1. Selecciona m√©todo `POST`
2. Copia y pega la URL
3. Ve a la pesta√±a **"Headers"**, agrega: `Content-Type` = `application/json`
4. Ve a la pesta√±a **"Body"**, selecciona **"raw"** y **"JSON"**
5. Copia el siguiente JSON:
```json
{
  "customerId": 123,
  "customerEmail": "cliente@example.com",
  "amount": 2660.00
}
```

**Respuesta esperada** (Status 200):
```json
{
  "id": 1,
  "customerId": 123,
  "customerEmail": "cliente@example.com",
  "amount": 2660.00,
  "status": "COMPLETED"
}
```

**Nota**: Guarda el `id` (paymentId) de la respuesta para usarlo en el siguiente paso.

#### 3. Crear la factura y disparar notificaciones (PASO PRINCIPAL) üöÄ

Este es el paso que dispara el sistema de notificaciones. El `billing-service` autom√°ticamente:
- ‚úÖ Crea la factura en la BD
- ‚úÖ Agrupa items por proveedor
- ‚úÖ Env√≠a notificaciones a Kafka (uno por cada proveedor)
- ‚úÖ Env√≠a notificaci√≥n JMS al cliente

**Configuraci√≥n en Postman:**

| Campo | Valor |
|-------|-------|
| **M√©todo** | `POST` |
| **URL** | `http://localhost:8083/api/invoices` |
| **Headers** | `Content-Type: application/json` |
| **Body** | raw ‚Üí JSON |

**Pasos:**
1. Selecciona m√©todo `POST`
2. Copia y pega la URL
3. Ve a la pesta√±a **"Headers"**, agrega: `Content-Type` = `application/json`
4. Ve a la pesta√±a **"Body"**, selecciona **"raw"** y **"JSON"**
5. Copia uno de los siguientes JSON (Opci√≥n A o B)

---

**Opci√≥n A: Sin paymentId previo (m√°s simple)**

**Body** (raw - JSON):
```json
{
  "customerId": 123,
  "customerEmail": "cliente@example.com",
  "amount": 2660.00,
  "items": [
    {
      "productId": 1,
      "productName": "Laptop",
      "supplierId": 1,
      "supplierName": "TechSupplier Inc",
      "supplierEmail": "orders@techsupplier.com",
      "quantity": 1,
      "unitPrice": 2500.00,
      "subtotal": 2500.00
    },
    {
      "productId": 2,
      "productName": "Mouse",
      "supplierId": 2,
      "supplierName": "Electronics Co",
      "supplierEmail": "sales@electronicsco.com",
      "quantity": 4,
      "unitPrice": 40.00,
      "subtotal": 160.00
    }
  ]
}
```

---

**Opci√≥n B: Con paymentId (flujo completo)**

Si creaste un pago en el paso 2, usa el `id` recibido como `paymentId`:

**Body** (raw - JSON):
```json
{
  "paymentId": 1,
  "customerId": 123,
  "customerEmail": "cliente@example.com",
  "amount": 2660.00,
  "items": [
    {
      "productId": 1,
      "productName": "Laptop",
      "supplierId": 1,
      "supplierName": "TechSupplier Inc",
      "supplierEmail": "orders@techsupplier.com",
      "quantity": 1,
      "unitPrice": 2500.00,
      "subtotal": 2500.00
    },
    {
      "productId": 2,
      "productName": "Mouse",
      "supplierId": 2,
      "supplierName": "Electronics Co",
      "supplierEmail": "sales@electronicsco.com",
      "quantity": 4,
      "unitPrice": 40.00,
      "subtotal": 160.00
    }
  ]
}
```

**Respuesta esperada** (Status 200):
```json
{
  "id": 1,
  "customerId": 123,
  "amount": 2660.00,
  "createdAt": "2025-10-15T20:00:00"
}
```

**‚ú® ¬°Al enviar esta petici√≥n, autom√°ticamente se disparan las notificaciones!**

#### 4. Ver notificaciones en logs (VERIFICACI√ìN)

**IMPORTANTE**: Abre dos terminales PowerShell separadas para ver ambos tipos de notificaciones simult√°neamente.

**Terminal 1 - Notificaciones a Proveedores (Kafka):**
```powershell
docker logs supplier-listener -f
```

Ver√°s logs como:
```
üîî NOTIFICACI√ìN RECIBIDA PARA PROVEEDOR
===============================================
Proveedor: TechSupplier Inc (tech@supplier.com)
Factura ID: 1
Total para este proveedor: $2500.00

Productos vendidos:
  - Laptop x1 @ $2500.00 = $2500.00

Mensaje consumido desde topic: supplier-1
===============================================
```

**Se crear√° un topic de Kafka por cada proveedor**: `supplier-1`, `supplier-2`, etc.

---

**Terminal 2 - Notificaciones a Clientes (JMS/MDB en WildFly):**
```powershell
docker logs notification-mdb -f
```

Ver√°s logs como:
```
üìß SIMULACI√ìN DE ENV√çO DE EMAIL
===============================================
TO: cliente@example.com
SUBJECT: Confirmaci√≥n de tu compra - Factura #1
BODY:
-----------------------------------------------
Hola Cliente #123,

Gracias por tu compra. Tu factura #1 ha sido generada exitosamente.

Detalles de tu compra:
  ‚Ä¢ Laptop - Cantidad: 1 - Precio: $2500.00
  ‚Ä¢ Mouse - Cantidad: 4 - Precio: $40.00

Total: $2660.00

Recibir√°s tu pedido en los pr√≥ximos d√≠as.

Saludos,
Sistema de Ventas
-----------------------------------------------
Mensaje procesado por MDB: CustomerNotificationMDB
===============================================
```

### Troubleshooting de Notificaciones

Si no ves las notificaciones despu√©s de enviar la petici√≥n desde Postman:

1. **Verificar que billing-service se conect√≥ correctamente:**
```powershell
docker logs billing-service | Select-String "Kafka"
docker logs billing-service | Select-String "JMS"
```

2. **Verificar topics de Kafka creados:**
```powershell
docker exec kafka kafka-topics --list --bootstrap-server localhost:9092
```

Deber√≠as ver topics como `supplier-1`, `supplier-2`, etc.

3. **Verificar conexi√≥n de WildFly a Artemis:**
```powershell
docker logs notification-mdb | Select-String "Artemis"
```

4. **Verificar que la petici√≥n en Postman fue exitosa:**
   - Status code debe ser `200 OK`
   - Debe devolver un JSON con el ID de la factura creada
   - Revisa la pesta√±a "Console" de Postman para ver detalles de la petici√≥n

## Arquitectura de Mensajer√≠a

### Kafka (Notificaciones a Proveedores)
- **Topics din√°micos**: `supplier-{supplierId}` (se crean autom√°ticamente)
- **Patr√≥n**: Point-to-Point (cada proveedor tiene su topic exclusivo)
- **Producer**: `billing-service` (KafkaSupplierNotificationService)
- **Consumer**: `supplier-listener` (subscrito al patr√≥n `supplier-.*`)
- **Serializaci√≥n**: JSON con Jackson
- **Configuraci√≥n**: 
  - Bootstrap servers: `kafka:9092`
  - Group ID: `supplier-listener-group`
  - Auto-offset: `earliest`

**Ejemplo de mensaje Kafka:**
```json
{
  "supplierId": 1,
  "supplierName": "TechSupplier Inc",
  "supplierEmail": "tech@supplier.com",
  "invoiceId": 1,
  "totalAmount": 2500.00,
  "products": [
    {
      "productId": 1,
      "productName": "Laptop",
      "quantity": 1,
      "unitPrice": 2500.00,
      "subtotal": 2500.00
    }
  ]
}
```

### JMS/Artemis (Notificaciones a Clientes)
- **Cola**: `customer-notifications`
- **Broker**: Artemis JMS integrado en WildFly (puerto 61616)
- **Producer**: `billing-service` (JmsCustomerNotificationService con Spring JMS)
- **Consumer**: `CustomerNotificationMDB` en WildFly
- **MDB**: Message Driven Bean que simula env√≠o de email
- **Serializaci√≥n**: JSON con Jackson (deserializado en el MDB)

**Ejemplo de mensaje JMS:**
```json
{
  "invoiceId": 1,
  "customerId": 123,
  "customerEmail": "cliente@example.com",
  "totalAmount": 2660.00,
  "purchasedItems": [
    {
      "productName": "Laptop",
      "quantity": 1,
      "price": 2500.00
    },
    {
      "productName": "Mouse",
      "quantity": 4,
      "price": 40.00
    }
  ]
}
```

**¬øPor qu√© no se usa ActiveMQ externo?**
WildFly 31 incluye Artemis JMS integrado de forma nativa, eliminando la necesidad de un contenedor ActiveMQ separado. Esto simplifica la arquitectura y reduce el overhead de infraestructura.

## Diagrama de Flujo

```
1. Cliente env√≠a checkout con items
   ‚Üì
2. payments-service registra el pago
   ‚Üì
3. billing-service crea factura con items
   ‚Üì
4. billing-service agrupa items por proveedor
   ‚Üì
5. Por cada proveedor:
      ‚Üí Env√≠a mensaje a Kafka topic "supplier-{id}"
      ‚Üí supplier-listener consume y registra
   ‚Üì
6. Para el cliente:
      ‚Üí Env√≠a mensaje a cola JMS "customer-notifications"
      ‚Üí MDB en WildFly consume y simula env√≠o de email
```

## Troubleshooting

### üîß Problemas Comunes

#### 1. Supplier-listener en restart constante

**S√≠ntoma**: `docker ps` muestra el contenedor reinici√°ndose continuamente.

**Causa**: Error de configuraci√≥n de Kafka o JAR mal compilado.

**Soluci√≥n**:
```powershell
# Ver logs para identificar el error
docker logs supplier-listener

# Si hay ClassNotFoundException, recompilar:
cd supplier-listener
mvn clean package -DskipTests
cd ..
docker-compose up -d --build supplier-listener
```

#### 2. Kafka no crea topics autom√°ticamente

**Verificar topics existentes:**
```powershell
docker exec kafka kafka-topics --list --bootstrap-server localhost:9092
```

**Crear topic manualmente (si es necesario):**
```powershell
docker exec kafka kafka-topics --create `
  --topic supplier-1 `
  --bootstrap-server localhost:9092 `
  --partitions 1 `
  --replication-factor 1
```

#### 3. MDB no consume mensajes de JMS

**Verificar logs de WildFly:**
```powershell
docker logs notification-mdb | Select-String "MDB"
docker logs notification-mdb | Select-String "customer-notifications"
```

**Verificar que WildFly est√° usando standalone-full.xml:**
```powershell
docker logs notification-mdb | Select-String "standalone-full"
```

Si no est√° usando `standalone-full.xml`, el Artemis JMS no estar√° disponible.

#### 4. Billing-service no se conecta a Kafka o JMS

**Verificar configuraci√≥n:**
```powershell
docker logs billing-service | Select-String "Kafka"
docker logs billing-service | Select-String "JMS"
```

**Verificar conectividad:**
```powershell
# Probar desde el contenedor
docker exec billing-service ping kafka -c 2
docker exec billing-service ping notification-mdb -c 2
```

#### 5. Servicios no se conectan entre s√≠

**Verificar que todos los health checks pasen:**
```powershell
docker-compose ps
```

Todos los servicios deben mostrar estado "Up" o "healthy".

**Verificar red de Docker:**
```powershell
docker network ls
docker network inspect taller5-arquisoft_default
```

#### 6. Error "Connection refused" al hacer curl

**Causa**: Los servicios a√∫n est√°n iniciando.

**Soluci√≥n**: Espera 1-2 minutos despu√©s de `docker-compose up` antes de hacer peticiones.

```powershell
# Ver progreso de inicio
docker-compose logs -f
```

#### 7. MySQL no est√° listo

**S√≠ntoma**: Servicios muestran errores de conexi√≥n a BD.

**Soluci√≥n**: Los health checks de MySQL tardan ~10 segundos. Espera a que docker-compose muestre "healthy" para los contenedores MySQL.

```powershell
# Verificar estado espec√≠fico de MySQL
docker-compose ps | Select-String "mysql"
```

## Comandos √ötiles

> **üí° Nota**: Para las peticiones HTTP, usa **Postman** con la colecci√≥n incluida (`postman_collection.json`). Los comandos a continuaci√≥n son para gesti√≥n de Docker y diagn√≥stico del sistema.

### Gesti√≥n de Contenedores

```powershell
# Levantar todos los servicios
docker-compose up -d

# Detener todos los servicios
docker-compose stop

# Ver logs de todos los servicios
docker-compose logs -f

# Ver logs de un servicio espec√≠fico
docker logs <nombre-servicio> -f

# Reiniciar un servicio espec√≠fico
docker-compose restart <nombre-servicio>

# Reconstruir y levantar un servicio espec√≠fico
docker-compose up -d --build <nombre-servicio>

# Ver estado de los contenedores
docker-compose ps

# Verificar uso de recursos
docker stats
```

### Limpieza del Sistema

```powershell
# Detener y eliminar contenedores (mantiene vol√∫menes)
docker-compose down

# Detener y eliminar contenedores Y vol√∫menes (limpieza completa)
docker-compose down -v

# Eliminar tambi√©n im√°genes construidas
docker-compose down -v --rmi all

# Limpiar todo el sistema Docker (¬°CUIDADO!)
docker system prune -a --volumes
```

### Acceso a Bases de Datos

```powershell
# Conectarse a MySQL Inventory
docker exec -it mysql_inventory mysql -u simis -p
# Password: 123456

# Conectarse a MySQL Billing
docker exec -it mysql_billing mysql -u simis -p

# Conectarse a MySQL Payments
docker exec -it mysql_payments mysql -u simis -p
```

### Inspecci√≥n de Kafka

```powershell
# Listar todos los topics
docker exec kafka kafka-topics --list --bootstrap-server localhost:9092

# Ver detalles de un topic
docker exec kafka kafka-topics --describe --topic supplier-1 --bootstrap-server localhost:9092

# Consumir mensajes de un topic (para debugging)
docker exec kafka kafka-console-consumer --topic supplier-1 --from-beginning --bootstrap-server localhost:9092

# Ver grupos de consumidores
docker exec kafka kafka-consumer-groups --list --bootstrap-server localhost:9092
```

## Estructura del Proyecto

```
taller5-ArquiSoft/
‚îú‚îÄ‚îÄ aggregator-service/          # DAL - Acceso a datos
‚îÇ   ‚îú‚îÄ‚îÄ src/main/java/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/taller5/aggregator/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dal/             # Servicios de acceso a datos
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dto/             # DTOs de transferencia
‚îÇ   ‚îî‚îÄ‚îÄ pom.xml
‚îú‚îÄ‚îÄ billing-service/             # Facturaci√≥n y notificaciones
‚îÇ   ‚îú‚îÄ‚îÄ src/main/java/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/taller5/billing/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ controller/      # REST endpoints
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ service/         # L√≥gica de notificaciones
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ config/          # Kafka y JMS config
‚îÇ   ‚îî‚îÄ‚îÄ pom.xml
‚îú‚îÄ‚îÄ inventory-service/           # Gesti√≥n de inventario
‚îú‚îÄ‚îÄ payments-service/            # Procesamiento de pagos
‚îú‚îÄ‚îÄ supplier-listener/           # Consumer Kafka
‚îÇ   ‚îú‚îÄ‚îÄ src/main/java/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/taller5/supplier/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ listener/        # Kafka listeners
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dto/             # DTOs de mensajes
‚îÇ   ‚îî‚îÄ‚îÄ pom.xml
‚îú‚îÄ‚îÄ notification-mdb/            # MDB para JMS
‚îÇ   ‚îú‚îÄ‚îÄ src/main/java/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/taller5/notification/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ mdb/             # Message Driven Beans
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dto/             # DTOs serializables
‚îÇ   ‚îî‚îÄ‚îÄ pom.xml
‚îú‚îÄ‚îÄ db/                          # Scripts SQL
‚îÇ   ‚îú‚îÄ‚îÄ db_inventory.sql
‚îÇ   ‚îú‚îÄ‚îÄ db_billing.sql
‚îÇ   ‚îî‚îÄ‚îÄ db_payments.sql
‚îî‚îÄ‚îÄ docker-compose.yml           # Orquestaci√≥n completa
```

## Notas Importantes

‚ö†Ô∏è **Puertos Utilizados**: Aseg√∫rate de que los siguientes puertos est√©n libres antes de levantar el sistema:
- 3307, 3308, 3309 (MySQL)
- 8081, 8082, 8083, 8084, 8085, 8090 (Servicios Spring Boot)
- 9092, 29092 (Kafka)
- 2181 (Zookeeper)
- 9990 (WildFly Admin)
- 61616 (Artemis JMS)

üîí **Credenciales por defecto**:
- MySQL: usuario `simis`, password `123456`
- WildFly Admin: usuario `admin`, password `admin123`

üöÄ **Recomendaciones**:
1. Usa `-d` (detached) para ejecutar contenedores en segundo plano
2. Revisa logs regularmente con `docker logs -f` para debugging
3. Usa `docker-compose ps` para verificar el estado de los servicios
4. Si cambias c√≥digo, recuerda recompilar con Maven antes de `docker-compose up --build`

